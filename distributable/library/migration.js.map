{"version":3,"sources":["../../source/library/migration.js"],"names":["Migration","BaseMigration","Path","Database","FilePath","_URL","fileURLToPath","import","meta","url","FolderPath","dirname","constructor","path","database","_database","isInstalled","open","existsTableMigration","isMigrationInstalled","_name","close","install","installMigration","uninstall","uninstallMigration","createDatabase","parameter","createMigration","name","normalize","templatePath","getMigration","databasePath","Promise","all","getMigrationFromPath","flat","sort","includePattern","excludePattern"],"mappings":"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","sourcesContent":["import { Migration as BaseMigration } from '@virtualpatterns/mablung-migration'\nimport Path from 'path'\n// import SQLFormat from 'sql-formatter'\n\nimport { Database } from './database.js'\n\nconst FilePath = __filePath\nconst FolderPath = Path.dirname(FilePath)\n\nclass Migration extends BaseMigration {\n\n  constructor(path, database) {\n    super(path)\n    this._database = database\n  }\n\n  /* c8 ignore next 3 */\n  get database() {\n    return this._database\n  }\n\n  async isInstalled() {\n\n    await this._database.open()\n\n    try {\n      return  (await this._database.existsTableMigration()) &&\n              (await this._database.isMigrationInstalled(this._name))\n    } finally {\n      await this._database.close()\n    }\n\n  }\n\n  install() {\n    return this._database.installMigration(this._name)\n  }\n\n  uninstall() {\n    return this._database.uninstallMigration(this._name)\n  }\n\n  static createDatabase(...parameter) {\n    return new Database(...parameter)\n  }\n\n  static createMigration(name, path = Path.normalize(`${FolderPath}/../../source/library/migration`), templatePath = Path.normalize(`${FolderPath}/../../source/library/migration/template.js`)) {\n    return super.createMigration(name, path, templatePath)\n  }\n\n  static async getMigration(...parameter) { // parameter is [ database ] or [ databasePath ]\n\n    let [ database ] = parameter\n    let [ databasePath ] = parameter\n\n    if (database instanceof Database) {\n      databasePath = database.path\n    } else {\n      database = this.createDatabase(databasePath)\n    }\n\n    return (await Promise.all([ super.getMigration(), this.getMigrationFromPath(`${FolderPath}/migration`, [ '*.js' ], [ 'template.js' ], database) ])).flat().sort()\n  \n  }\n\n  static getMigrationFromPath(path, includePattern, excludePattern, ...parameter) { // parameter is [ database ] or [ databasePath ]\n\n    let [ database ] = parameter\n    let [ databasePath ] = parameter\n\n    if (database instanceof Database) {\n      databasePath = database.path\n    } else {\n      database = this.createDatabase(databasePath)\n    }\n\n    return super.getMigrationFromPath(path, includePattern, excludePattern, database)\n\n  }\n\n  static async installMigration(...parameter) { // parameter is [ database ] or [ databasePath ]\n\n    let [ database ] = parameter\n    let [ databasePath ] = parameter\n    // let onTrace = null\n\n    if (database instanceof Database) {\n      databasePath = database.path\n    } else {\n      database = this.createDatabase(databasePath)\n    }\n\n    await database.open()\n    // database.on('trace', onTrace = (statement) => {\n    //   console.log('-'.repeat(80))\n    //   console.log('Database.on(\\'trace\\', (statement) => { ... })')\n    //   console.log('-'.repeat(80))\n    //   console.log()\n    //   console.log(SQLFormat.format(statement))\n    //   console.log()\n    // })\n\n    try {\n      await super.installMigration(database)\n    } finally {\n      // database.off('trace', onTrace)\n      await database.close()\n    }\n\n  }\n\n  static async uninstallMigration(...parameter) { // parameter is [ database ] or [ databasePath ]\n  \n    let [ database ] = parameter\n    let [ databasePath ] = parameter\n    // let onTrace = null\n\n    if (database instanceof Database) {\n      databasePath = database.path\n    } else {\n      database = this.createDatabase(databasePath)\n    }\n\n    await database.open()\n    // database.on('trace', onTrace = (statement) => {\n    //   console.log('-'.repeat(80))\n    //   console.log('Database.on(\\'trace\\', (statement) => { ... })')\n    //   console.log('-'.repeat(80))\n    //   console.log()\n    //   console.log(SQLFormat.format(statement))\n    //   console.log()\n    // })\n\n    try {\n      await super.uninstallMigration(database)\n    } finally {\n      // database.off('trace', onTrace)\n      await database.close()\n    }\n\n  }\n\n}\n\nexport { Migration }\n"],"file":"migration.js"}